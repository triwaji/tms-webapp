<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Transport Management System">
    <title>TMS - Transport Management System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Excel Processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <style>
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6b46c1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen">
        <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
                <div class="loader mx-auto mb-4"></div>
                <p class="text-gray-600">Loading TMS...</p>
            </div>
        </div>
    </div>
    
    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>

    <!-- SUPABASE JS LIBRARY - LOAD FIRST -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    
    <!-- MAIN APPLICATION -->
    <script>
        // Wait for Supabase to load
        window.addEventListener('DOMContentLoaded', function() {
            // Check if Supabase loaded
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase failed to load. Loading backup...');
                // Load backup CDN
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js';
                script.onload = function() {
                    console.log('Backup Supabase loaded');
                    initializeApp();
                };
                document.head.appendChild(script);
            } else {
                console.log('Supabase loaded successfully');
                initializeApp();
            }
        });
        
        function initializeApp() {
            console.log('Initializing TMS application...');
            console.log('Supabase available:', typeof window.supabase !== 'undefined');
            
            // ====================================
            // KONFIGURASI - EDIT BAGIAN INI!
            // ====================================
            window.CONFIG = {
            SUPABASE_URL: 'https://fkodrpwdtavfxxpixzxn.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrb2RycHdkdGF2Znh4cGl4enhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMjg1MDcsImV4cCI6MjA3MjgwNDUwN30.vJAfuqr8uv2twwaJABQyRzDJ8xFu0EY7s4l-MNVgF-A, // Ganti dengan key Anda
            DEMO_MODE: false
            };
        
         function initializeApp() {
            console.log('Initializing TMS application...');
            const CONFIG = window.CONFIG; // Use global CONFIG
            
            // ====================================
            // SUPABASE CLIENT
            // ====================================
            let supabaseClient = null;
            
            // Initialize Supabase if configured
            if (!CONFIG.DEMO_MODE && CONFIG.SUPABASE_URL !== 'https://fkodrpwdtavfxxpixzxn.supabase.co') {
                try {
                    console.log('Creating Supabase client...');
                    supabaseClient = window.supabase.createClient(
                        CONFIG.SUPABASE_URL,
                        CONFIG.SUPABASE_ANON_KEY
                    );
                    console.log('Supabase client created successfully');
                } catch (error) {
                    console.error('Error creating Supabase client:', error);
                }
            }
            
            // ====================================
            // STATE MANAGEMENT
            // ====================================
            window.AppState = {
                user: null,
                userRole: null,
                currentView: 'login',
                loading: false
            };
            
            // ====================================
            // UTILITY FUNCTIONS
            // ====================================
            window.Utils = {
                showToast: function(message, type = 'info') {
                    const container = document.getElementById('toast-container');
                    if (!container) return;
                    
                    const toast = document.createElement('div');
                    const colors = {
                        success: 'bg-green-500',
                        error: 'bg-red-500',
                        warning: 'bg-yellow-500',
                        info: 'bg-blue-500'
                    };
                    
                    toast.className = colors[type] + ' text-white px-6 py-3 rounded-lg shadow-lg mb-2 animate-pulse';
                    toast.innerHTML = '<i class="fas fa-info-circle mr-2"></i>' + message;
                    
                    container.appendChild(toast);
                    setTimeout(function() {
                        toast.remove();
                    }, 3000);
                }
            };
            
            // ====================================
            // AUTHENTICATION FUNCTIONS
            // ====================================
            window.handleLogin = async function(event) {
                event.preventDefault();
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                
                console.log('Login attempt:', email);
                
                // Demo login - always available
                if (email === 'demo@tms.com' && password === 'demo123') {
                    console.log('Demo login successful');
                    window.AppState.user = { email: 'demo@tms.com' };
                    window.AppState.userRole = 'admin';
                    localStorage.setItem('tms_user', JSON.stringify({
                        user: window.AppState.user,
                        role: window.AppState.userRole
                    }));
                    window.Utils.showToast('Login berhasil (Demo Mode)!', 'success');
                    renderDashboard();
                    return;
                }
                
                // Supabase login
                if (!CONFIG.DEMO_MODE && supabaseClient) {
                    try {
                        console.log('Attempting Supabase login...');
                        
                        const { data, error } = await supabaseClient.auth.signInWithPassword({
                            email: email,
                            password: password
                        });
                        
                        if (error) {
                            console.error('Supabase login error:', error);
                            
                            // Handle specific errors
                            if (error.message.includes('Invalid login credentials')) {
                                window.Utils.showToast('Email atau password salah', 'error');
                            } else if (error.message.includes('Email not confirmed')) {
                                window.Utils.showToast('Email belum dikonfirmasi. Cek inbox email Anda.', 'warning');
                            } else {
                                window.Utils.showToast('Login error: ' + error.message, 'error');
                            }
                            return;
                        }
                        
                        console.log('Supabase login successful');
                        
                        // Get user role from database
                        const { data: userData, error: userError } = await supabaseClient
                            .from('users')
                            .select('*')
                            .eq('email', email)
                            .single();
                        
                        if (userError) {
                            console.warn('Could not fetch user data:', userError);
                            // Create user record if not exists
                            await supabaseClient.from('users').insert({
                                id: data.user.id,
                                email: email,
                                full_name: email.split('@')[0],
                                role: 'admin',
                                is_active: true,
                                password_hash: 'not_used_for_auth'
                            });
                        }
                        
                        window.AppState.user = data.user;
                        window.AppState.userRole = userData?.role || 'admin';
                        
                        localStorage.setItem('tms_user', JSON.stringify({
                            user: window.AppState.user,
                            role: window.AppState.userRole
                        }));
                        
                        window.Utils.showToast('Login berhasil!', 'success');
                        renderDashboard();
                        
                    } catch (err) {
                        console.error('Login exception:', err);
                        window.Utils.showToast('Error: ' + err.message, 'error');
                    }
                } else {
                    // No Supabase configured
                    window.Utils.showToast('Login gagal. Gunakan demo account atau setup Supabase.', 'error');
                }
            };
            
            window.logout = function() {
                window.AppState.user = null;
                window.AppState.userRole = null;
                localStorage.removeItem('tms_user');
                if (supabaseClient) {
                    supabaseClient.auth.signOut();
                }
                renderLogin();
                window.Utils.showToast('Logout berhasil', 'info');
            };
            
            // ====================================
            // RENDER FUNCTIONS
            // ====================================
            function renderLogin() {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 to-blue-600 p-4">
                        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
                            <div class="text-center mb-8">
                                <div class="inline-flex items-center justify-center w-20 h-20 bg-purple-100 rounded-full mb-4">
                                    <i class="fas fa-truck text-3xl text-purple-600"></i>
                                </div>
                                <h1 class="text-3xl font-bold text-gray-800">TMS Login</h1>
                                <p class="text-gray-600 mt-2">Transport Management System</p>
                            </div>
                            
                            <form onsubmit="handleLogin(event)" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-envelope mr-2"></i>Email
                                    </label>
                                    <input type="email" id="email" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="user@example.com">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        <i class="fas fa-lock mr-2"></i>Password
                                    </label>
                                    <input type="password" id="password" required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="••••••••">
                                </div>
                                
                                <button type="submit"
                                    class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold py-3 rounded-lg hover:from-purple-700 hover:to-blue-700 transition">
                                    <i class="fas fa-sign-in-alt mr-2"></i>Masuk
                                </button>
                            </form>
                            
                            <div class="mt-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                                <p class="text-sm font-semibold text-yellow-800 mb-2">
                                    <i class="fas fa-info-circle mr-1"></i>Demo Account:
                                </p>
                                <p class="text-sm text-yellow-700">
                                    Email: demo@tms.com<br>
                                    Password: demo123
                                </p>
                            </div>
                            
                            ${CONFIG.DEMO_MODE ? `
                                <div class="mt-4 text-center text-xs text-gray-500">
                                    Running in DEMO MODE
                                </div>
                            ` : `
                                <div class="mt-4 text-center text-xs text-green-600">
                                    <i class="fas fa-check-circle mr-1"></i>Connected to Supabase
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }
            
            function renderDashboard() {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="flex h-screen bg-gray-100">
                        <!-- Sidebar -->
                        <div class="w-64 bg-white shadow-lg">
                            <div class="p-6 bg-gradient-to-r from-purple-600 to-blue-600 text-white">
                                <h2 class="text-xl font-bold">TMS Portal</h2>
                                <p class="text-sm opacity-90 mt-1">${window.AppState.userRole?.toUpperCase() || 'USER'}</p>
                            </div>
                            
                            <div class="p-4 border-b">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-user text-purple-600"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm font-medium text-gray-900">${window.AppState.user?.email || 'User'}</p>
                                        <p class="text-xs text-gray-500">Online</p>
                                    </div>
                                </div>
                            </div>
                            
                            <nav class="mt-4">
                                <button onclick="navigateTo('dashboard')" class="w-full text-left px-6 py-3 text-gray-700 hover:bg-purple-50 flex items-center">
                                    <i class="fas fa-tachometer-alt mr-3"></i>Dashboard
                                </button>
                                <button onclick="navigateTo('orders')" class="w-full text-left px-6 py-3 text-gray-700 hover:bg-purple-50 flex items-center">
                                    <i class="fas fa-box mr-3"></i>Orders
                                </button>
                                <button onclick="navigateTo('vehicles')" class="w-full text-left px-6 py-3 text-gray-700 hover:bg-purple-50 flex items-center">
                                    <i class="fas fa-truck mr-3"></i>Vehicles
                                </button>
                                <button onclick="navigateTo('planning')" class="w-full text-left px-6 py-3 text-gray-700 hover:bg-purple-50 flex items-center">
                                    <i class="fas fa-route mr-3"></i>Planning
                                </button>
                                <button onclick="navigateTo('monitoring')" class="w-full text-left px-6 py-3 text-gray-700 hover:bg-purple-50 flex items-center">
                                    <i class="fas fa-map-marked-alt mr-3"></i>Monitoring
                                </button>
                                <button onclick="navigateTo('reports')" class="w-full text-left px-6 py-3 text-gray-700 hover:bg-purple-50 flex items-center">
                                    <i class="fas fa-chart-bar mr-3"></i>Reports
                                </button>
                            </nav>
                            
                            <div class="absolute bottom-0 w-64 p-4">
                                <button onclick="logout()" class="w-full bg-red-500 text-white py-2 rounded-lg hover:bg-red-600 flex items-center justify-center">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                                </button>
                            </div>
                        </div>
                        
                        <!-- Main Content -->
                        <div class="flex-1 overflow-auto">
                            <header class="bg-white shadow-sm px-8 py-4">
                                <h1 class="text-2xl font-semibold text-gray-800">Dashboard</h1>
                            </header>
                            <div class="p-8">
                                <div id="mainContent">
                                    ${renderDashboardContent()}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            function renderDashboardContent() {
                return `
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-blue-100 rounded-full">
                                    <i class="fas fa-box text-2xl text-blue-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-gray-500 text-sm">Total Orders</p>
                                    <p class="text-2xl font-bold">1,245</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-green-100 rounded-full">
                                    <i class="fas fa-truck text-2xl text-green-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-gray-500 text-sm">Active Deliveries</p>
                                    <p class="text-2xl font-bold">48</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-purple-100 rounded-full">
                                    <i class="fas fa-car text-2xl text-purple-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-gray-500 text-sm">Available Vehicles</p>
                                    <p class="text-2xl font-bold">126</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <div class="flex items-center">
                                <div class="p-3 bg-orange-100 rounded-full">
                                    <i class="fas fa-file-invoice-dollar text-2xl text-orange-600"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-gray-500 text-sm">Pending Invoices</p>
                                    <p class="text-2xl font-bold">23</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="Utils.showToast('Opening create order...', 'info')" class="p-4 bg-purple-50 rounded-lg hover:bg-purple-100 transition">
                                    <i class="fas fa-plus-circle text-2xl text-purple-600"></i>
                                    <p class="mt-2 text-sm font-medium">New Order</p>
                                </button>
                                <button onclick="Utils.showToast('Opening vehicle assignment...', 'info')" class="p-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition">
                                    <i class="fas fa-truck-moving text-2xl text-blue-600"></i>
                                    <p class="mt-2 text-sm font-medium">Assign Vehicle</p>
                                </button>
                                <button onclick="Utils.showToast('Opening trip planning...', 'info')" class="p-4 bg-green-50 rounded-lg hover:bg-green-100 transition">
                                    <i class="fas fa-route text-2xl text-green-600"></i>
                                    <p class="mt-2 text-sm font-medium">Plan Trip</p>
                                </button>
                                <button onclick="Utils.showToast('Opening reports...', 'info')" class="p-4 bg-orange-50 rounded-lg hover:bg-orange-100 transition">
                                    <i class="fas fa-chart-line text-2xl text-orange-600"></i>
                                    <p class="mt-2 text-sm font-medium">View Reports</p>
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-lg font-semibold mb-4">Recent Activity</h3>
                            <div class="space-y-3">
                                <div class="flex items-center p-3 bg-gray-50 rounded">
                                    <div class="w-2 h-2 bg-green-500 rounded-full mr-3"></div>
                                    <div>
                                        <p class="text-sm font-medium">Order #2401040174 delivered</p>
                                        <p class="text-xs text-gray-500">2 minutes ago</p>
                                    </div>
                                </div>
                                <div class="flex items-center p-3 bg-gray-50 rounded">
                                    <div class="w-2 h-2 bg-blue-500 rounded-full mr-3"></div>
                                    <div>
                                        <p class="text-sm font-medium">Vehicle B 1234 CD assigned</p>
                                        <p class="text-xs text-gray-500">15 minutes ago</p>
                                    </div>
                                </div>
                                <div class="flex items-center p-3 bg-gray-50 rounded">
                                    <div class="w-2 h-2 bg-yellow-500 rounded-full mr-3"></div>
                                    <div>
                                        <p class="text-sm font-medium">New order #2401040175 created</p>
                                        <p class="text-xs text-gray-500">1 hour ago</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Status -->
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">System Status</h3>
                        <div class="grid grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-12 h-12 bg-green-100 rounded-full mb-2">
                                    <i class="fas fa-check text-green-600"></i>
                                </div>
                                <p class="text-sm font-medium">Database</p>
                                <p class="text-xs text-gray-500">Connected</p>
                            </div>
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-12 h-12 bg-green-100 rounded-full mb-2">
                                    <i class="fas fa-check text-green-600"></i>
                                </div>
                                <p class="text-sm font-medium">API</p>
                                <p class="text-xs text-gray-500">Operational</p>
                            </div>
                            <div class="text-center">
                                <div class="inline-flex items-center justify-center w-12 h-12 ${CONFIG.DEMO_MODE ? 'bg-yellow-100' : 'bg-green-100'} rounded-full mb-2">
                                    <i class="fas ${CONFIG.DEMO_MODE ? 'fa-exclamation' : 'fa-check'} ${CONFIG.DEMO_MODE ? 'text-yellow-600' : 'text-green-600'}"></i>
                                </div>
                                <p class="text-sm font-medium">Mode</p>
                                <p class="text-xs text-gray-500">${CONFIG.DEMO_MODE ? 'Demo' : 'Production'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ====================================
            // NAVIGATION FUNCTIONS
            // ====================================
            window.navigateTo = function(view) {
                console.log('Navigating to:', view);
                window.AppState.currentView = view;
                
                const content = document.getElementById('mainContent');
                if (!content) return;
                
                // Update header
                const header = document.querySelector('header h1');
                if (header) {
                    const titles = {
                        dashboard: 'Dashboard',
                        orders: 'Orders Management',
                        vehicles: 'Vehicle Management',
                        planning: 'Delivery Planning',
                        monitoring: 'Trip Monitoring',
                        reports: 'Reports & Analytics'
                    };
                    header.textContent = titles[view] || 'Dashboard';
                }
                
                // Simple content for now
                switch(view) {
                    case 'orders':
                        content.innerHTML = `
                            <div class="bg-white rounded-lg shadow p-6">
                                <h2 class="text-xl font-semibold mb-4">Orders Management</h2>
                                <p class="text-gray-600">Order management interface will be displayed here.</p>
                            </div>
                        `;
                        break;
                    case 'vehicles':
                        content.innerHTML = `
                            <div class="bg-white rounded-lg shadow p-6">
                                <h2 class="text-xl font-semibold mb-4">Vehicle Management</h2>
                                <p class="text-gray-600">Vehicle management interface will be displayed here.</p>
                            </div>
                        `;
                        break;
                    default:
                        content.innerHTML = renderDashboardContent();
                }
            };
            
            // ====================================
            // INITIALIZATION
            // ====================================
            function init() {
                console.log('=== TMS INITIALIZATION ===');
                console.log('Supabase loaded:', typeof window.supabase !== 'undefined');
                console.log('Config:', {
                    url: CONFIG.SUPABASE_URL.substring(0, 30) + '...',
                    hasKey: CONFIG.SUPABASE_ANON_KEY !== 'your-anon-key-here',
                    demoMode: CONFIG.DEMO_MODE
                });
                
                // Check for saved session
                const savedUser = localStorage.getItem('tms_user');
                if (savedUser) {
                    try {
                        const userData = JSON.parse(savedUser);
                        window.AppState.user = userData.user;
                        window.AppState.userRole = userData.role;
                        console.log('Restored session for:', userData.user.email);
                        renderDashboard();
                    } catch(e) {
                        console.log('No valid session found');
                        renderLogin();
                    }
                } else {
                    renderLogin();
                }
            }
            
            // Start the application
            init();
        }
    </script>
</body>
</html>
